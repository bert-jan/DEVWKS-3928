# Configure Templates and Policies
We are now going to run the Templates and Policies playbooks that we defined in the previous section.

## Step 1 - Modify the top level build.yml playbook to uncomment the task04_template_policy role
We will now modify the top level **build.yml** playbook to include the task04_template_policy role.

Visual Studio Code Terminal

`code -r /home/cisco/CiscoLive/DEVWKS-3928/build.yml`

Uncomment the role on line 10 called **task04_template_policy** in the file and press Ctrl+s to save it.

**`build.yml`**
```
---
# This is the top level build playbook that runs the various
# Ansible roles that will be used to build out the fabric
- name: Build Out Fabric on NDFC
  hosts: ndfc
  gather_facts: false
  roles:
    - task01_interfaces
    - task02_overlay
    - task04_template_policy
```

## Step 2 - Make sure you are in the root directory of the project folder

Visual Studio Code Terminal

`cd /home/cisco/CiscoLive/DEVWKS-3928`

## Step 3 - Run the build.yml Ansible playbook to configure Telemetry
If you recall from the previous section, the main.yml file for this role includes various Ansible task files.

**`roles/task04_template_policy/tasks/main.yml`**
```
---
# This main.yml file includes two task files that will be used to
# define and apply templates and policies
- { include: template_telemetry.yml, tags: ['telemetry'] }
- { include: template_variables.yml, tags: ['ntp_vars'] }
```

When we run the Ansible role playbook we are going to use the **--tags** option to specify the file to include. Without the **--tags** option both of the files above (lines 4 and 5) would be included in the run.

First we only want to run the tasks defined in **template_telemetry.yml** so run the Ansible role playbook using the **--tags telemetry** option so that only the telemetry template and policies get applied.

Use the following password when prompted for the Ansible Vault Password in the step below:

* Username: cisco.123

Visual Studio Code Terminal

**`ansible-playbook -i hosts.stage.yml build.yml --ask-vault-password --tags telemetry`**

Output
```
➜  DEVWKS-3928 git:(stage) ✗ ansible-playbook -i hosts.stage.yml build.yml --ask-vault-password --tags telemetry
Vault password:

PLAY [Build Out Fabric on NDFC] *******************************************************************************************************************************************************************

TASK [task04_template_policy : Create Template To Enable Telemetry Feature] ***********************************************************************************************************************
changed: [10.15.0.59]

TASK [task04_template_policy : Create Template For Telemetry Configuration] ***********************************************************************************************************************
changed: [10.15.0.59]

TASK [task04_template_policy : Create and Apply Policy for Telemetry Configuration] ***************************************************************************************************************
changed: [10.15.0.59]

TASK [task04_template_policy : Query Policies] ****************************************************************************************************************************************************
ok: [10.15.0.59]

TASK [task04_template_policy : Display Query Result] **********************************************************************************************************************************************
ok: [10.15.0.59] => {
    "msg": [
        {
            "autoGenerated": false,
            "createdOn": 1654119560790,
            "deleted": false,
            "description": "",
            "editable": true,
            "entityName": "SWITCH",
            "entityType": "SWITCH",
            "fabricName": "fabric-stage",
            "generatedConfig": "feature telemetry\n\n\n",
            "id": 64890,
            "ipAddress": "10.15.17.12",
            "modifiedOn": 1654119560790,
            "nvPairs": {
                "FABRIC_NAME": "fabric-stage"
            },
            "policyId": "POLICY-64890",
            "priority": 1,
            "resourcesLinked": "",
            "serialNumber": "94U7UQLLLO7",
            "source": "",
            "status": "NA",
            "statusOn": 1654119560790,
            "switchName": "staging-leaf1",
            "templateContentType": "TEMPLATE_CLI",
            "templateName": "template_telemetry_feature"
        },
        {
            "autoGenerated": false,
            "createdOn": 1654119560851,
            "deleted": false,
            "description": "",
            "editable": true,
            "entityName": "SWITCH",
            "entityType": "SWITCH",
            "fabricName": "fabric-stage",
            "generatedConfig": "telemetry\n  certificate /bootflash/telegraf.crt telegraf\n  destination-profile\n    use-vrf management\n  destination-group 101\n    ip address 192.168.55.55 port 57101 protocol gRPC encoding GPB\n  sensor-group 101\n    data-source DME\n    path sys/ch depth unbounded\n  subscription 101\n    dst-grp 101\n    snsr-grp 101 sample-interval 10101\n\n\n",
            "id": 64900,
            "ipAddress": "10.15.17.12",
            "modifiedOn": 1654119560851,
            "nvPairs": {
                "FABRIC_NAME": "fabric-stage"
            },
            "policyId": "POLICY-64900",
            "priority": 2,
            "resourcesLinked": "",
            "serialNumber": "94U7UQLLLO7",
            "source": "",
            "status": "NA",
            "statusOn": 1654119560851,
            "switchName": "staging-leaf1",
            "templateContentType": "TEMPLATE_CLI",
            "templateName": "template_telemetry"
        }
    ]
}

PLAY RECAP ****************************************************************************************************************************************************************************************
10.15.0.59                 : ok=5    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

➜  DEVWKS-3928 git:(stage) ✗
```
Notice that the only task that ran was the include file task with the **telemetry** tag. This is an easy way to select the execution path using Ansible tags.

**NOTE:** Your policy numbers will very likey differ from the example output in the lab guide. NDFC manages the policy numbering so this is nothing to be concerned about.

## Step 4 - Run the build.yml Ansible playbook to configure an NTP Server.
This time use the **--tags ntp_vars** option to only include the **template_variables.yml** task file and configure the NTP server IP addresses.

>## Note
>Use the following password when prompted for the Ansible vault password in the next step

* Password: cisco.123

**`roles/task04_template_policy/tasks/main.yml`**
```
---
# This main.yml file includes two task files that will be used to
# define and apply templates and policies
- { include: template_telemetry.yml, tags: ['telemetry'] }
- { include: template_variables.yml, tags: ['ntp_vars'] }
```

Visual Studio Code Terminal

**`ansible-playbook -i hosts.stage.yml build.yml --ask-vault-password --tags ntp_vars`**

Output:
```
➜  DEVWKS-3928 git:(stage) ✗ ansible-playbook -i hosts.stage.yml build.yml --ask-vault-password --tags ntp_vars
Vault password:

PLAY [Build Out Fabric on NDFC] *******************************************************************************************************************************************************************

TASK [task04_template_policy : Create an NTP Server using the ntp_server NDFC template] ***********************************************************************************************************
changed: [10.15.0.59]

PLAY RECAP ****************************************************************************************************************************************************************************************
10.15.0.59                 : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

➜  DEVWKS-3928 git:(stage) ✗
```

This time, only the tasks to configure the NTP server using the ntp_server Template and Policy were run.

![](https://github.com/bert-jan/DEVWKS-3928/blob/main/task04_template_policy/workflow_task04.png)
